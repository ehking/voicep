# مترجم ویس‌های شلوغ ایرانی - حالت تمام‌خودکار

این پروژه یک سرویس FastAPI تماماً محلی است که فایل صوتی فارسی را بدون دخالت کاربر تحلیل می‌کند، نوع آن را (گفتار/موسیقی/ترکیبی) تشخیص می‌دهد، مسیر پردازش مناسب را انتخاب می‌کند، گفتار را استخراج و متن را پاک‌سازی می‌کند. همه‌چیز در همین ماشین اجرا می‌شود و هیچ API بیرونی فراخوانی نمی‌شود.

## پیش‌نیازها
- Python 3.10+
- Ubuntu 22.04 (تست شده)
- نصب ffmpeg و ffprobe
  ```bash
  sudo apt-get update && sudo apt-get install -y ffmpeg
  ```
- (اختیاری) GPU و درایور CUDA برای عملکرد بهتر مدل‌های whisper/faster-whisper
- (اختیاری) نصب demucs برای کاهش پیشرفته موسیقی

## راه‌اندازی محیط مجازی
```bash
python3 -m venv .venv
source .venv/bin/activate
```

## نصب وابستگی‌ها
```bash
pip install --upgrade pip
pip install -r requirements.txt
```

## پیکربندی
مقادیر محیطی در `.env.example` آمده است. برای سفارشی‌سازی یک فایل `.env` بسازید:
```bash
cp .env.example .env
```
متغیرهای مهم:
- `MODEL_SIZE`: اندازه مدل whisper/faster-whisper (پیش‌فرض `small`)
- `MODEL_DEVICE`: دستگاه اجرای مدل (`cpu` یا `cuda`)
- `COMPUTE_TYPE`: نوع محاسبه مدل (`int8`, `float16` و ...)
- `PROMPT_BALANCED`, `PROMPT_NOISY`, `PROMPT_MUSIC_MIXED`: پرامپت‌های فارسی برای پروفایل‌های خودکار ASR
- `RETENTION_HOURS`: مدت نگهداری فایل‌ها و رکوردها (ساعت)
- `MAX_MB`: حداکثر حجم فایل (مگابایت)
- `MAX_SECONDS`: حداکثر طول فایل (ثانیه)
- `STORAGE_DIR`: مسیر ذخیره‌سازی محلی
- `WORKER_THREADS`: تعداد نخ‌های پردازش پس‌زمینه (پیش‌فرض ۲)
- `MAX_QUEUE_SIZE`: حداکثر طول صف پردازش قبل از بازگشت خطای 429
- `USE_MLM_CORRECTION`: فعال‌سازی اصلاح زبانی مبتنی بر مدل ماسک (اختیاری)
- `DEMUCS_ENABLED`: در صورت نصب demucs، برای استفاده از جداسازی خواننده روی ۱ بگذارید

## اجرای برنامه
```bash
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```
سپس در مرورگر به آدرس `http://localhost:8000/` بروید.

## عملکرد اصلی (حالت AUTO)
- آپلود چند فایل صوتی به‌صورت هم‌زمان (حداکثر ۲۰ مگابایت و ۵ دقیقه برای هر فایل)
- صف پردازش با `queue.Queue`، پشتیبانی از چند نخ و کنترل ظرفیت (پیش‌فرض ۲ worker و ۱۰۰ صف)
- تبدیل به WAV 16k مونو، سپس **تحلیل خودکار** شامل نسبت گفتار، احتمال موسیقی، برآورد SNR و تشخیص نوع فایل
- انتخاب خودکار پروفایل‌ها:
  - موسیقی خالص → یک بار سرکوب موسیقی، تحلیل مجدد و در صورت نبود گفتار، خطای «MUSIC_ONLY»
  - ترکیبی → سرکوب موسیقی + حذف نویز + پروفایل ASR مخصوص موسیقی
  - گفتار → پروفایل متعادل یا پرنویز بر اساس SNR
- حذف نویز (RNNoise در صورت وجود، در غیر این صورت `noisereduce`)
- تشخیص گفتار با `faster-whisper` (در صورت عدم وجود، `whisper` داخلی) با پرامپت‌های خودکار
- پاکسازی متن فارسی و ارائه هر دو نسخه خام و تمیز
- رابط کاربری RTL فارسی با به‌روزرسانی زنده، نشان دادن نوع صوت، پروفایل انتخاب‌شده و شاخص‌های تحلیل
- تاریخچه ۱۰ درخواست اخیر و مشاهدهٔ نتیجهٔ هر کار
- پاک‌سازی زمان‌بندی‌شده فایل‌ها/رکوردهای قدیمی (هر ساعت)
- در هنگام راه‌اندازی، درخواست‌های نیمه‌تمام مجدد در صف قرار می‌گیرند.

## مشکلات رایج
- **نبود `faster-whisper` یا عدم دسترسی GPU**: برنامه به‌صورت خودکار به پکیج `whisper` بازمی‌گردد. سرعت پایین‌تر است اما عملکرد حفظ می‌شود.
- **نبود RNNoise**: حذف نویز با کتابخانه `noisereduce` انجام می‌شود.
- **نبود demucs**: سرکوب موسیقی با فیلتر باندپَس و فشرده‌سازی نرم انجام می‌شود.
- **خطای ffmpeg/ffprobe**: مطمئن شوید ffmpeg نصب و در PATH است.
- **مصرف حافظه مدل**: در صورت محدودیت منابع، از مدل کوچک‌تر (مثلاً `tiny` یا `base`) استفاده کنید.
- **خطای صف پر (429)**: مقدار `MAX_QUEUE_SIZE` را افزایش دهید یا با `WORKER_THREADS` بیشتر، پردازش را موازی‌تر کنید.
