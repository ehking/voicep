# مترجم ویس‌های شلوغ ایرانی (فاز ۱)

این پروژه یک MVP محلی برای آپلود فایل صوتی فارسی، حذف نویز، تبدیل گفتار به متن و پاکسازی متن است. تمامی پردازش‌ها روی سیستم محلی انجام می‌شود و هیچ وابستگی به API خارجی ندارد.

## پیش‌نیازها
- Python 3.10+
- Ubuntu 22.04 (تست شده)
- نصب ffmpeg و ffprobe
  ```bash
  sudo apt-get update && sudo apt-get install -y ffmpeg
  ```
- (اختیاری) GPU و درایور CUDA برای عملکرد بهتر مدل‌های whisper

## راه‌اندازی محیط مجازی
```bash
python3 -m venv .venv
source .venv/bin/activate
```

## نصب وابستگی‌ها
```bash
pip install --upgrade pip
pip install -r requirements.txt
```

## پیکربندی
مقادیر محیطی در `.env.example` آمده است. برای سفارشی‌سازی یک فایل `.env` بسازید:
```bash
cp .env.example .env
```
متغیرهای مهم:
- `MODEL_SIZE`: اندازه مدل whisper/faster-whisper (پیش‌فرض `small`)
- `RETENTION_HOURS`: مدت نگهداری فایل‌ها و رکوردها (ساعت)
- `MAX_MB`: حداکثر حجم فایل (مگابایت)
- `MAX_SECONDS`: حداکثر طول فایل (ثانیه)
- `STORAGE_DIR`: مسیر ذخیره‌سازی محلی
- `WORKER_THREADS`: تعداد نخ‌های پردازش پس‌زمینه

## اجرای برنامه
```bash
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```
سپس در مرورگر به آدرس `http://localhost:8000/` بروید.

## عملکرد اصلی
- آپلود فایل صوتی (حداکثر ۲۰ مگابایت و ۵ دقیقه)
- صف پردازش با `queue.Queue` و نخ پس‌زمینه
- تبدیل به WAV، حذف نویز (RNNoise در صورت وجود، در غیر این صورت `noisereduce`)
- تشخیص گفتار با `faster-whisper` (در صورت عدم وجود، `whisper` داخلی)
- پاکسازی متن فارسی شامل نرمال‌سازی حروف و حذف کلمات پرکننده
- تاریخچه ۱۰ درخواست اخیر
- دکمه‌های کپی و دانلود متن تمیز
- پاک‌سازی زمان‌بندی‌شده فایل‌ها/رکوردهای قدیمی (هر ساعت)
- در هنگام راه‌اندازی، درخواست‌های نیمه‌تمام مجدد در صف قرار می‌گیرند.

## مشکلات رایج
- **نبود `faster-whisper` یا عدم دسترسی GPU**: برنامه به‌صورت خودکار به پکیج `whisper` بازمی‌گردد. سرعت پایین‌تر است اما عملکرد حفظ می‌شود.
- **نبود RNNoise**: حذف نویز با کتابخانه `noisereduce` انجام می‌شود.
- **خطای ffmpeg/ffprobe**: مطمئن شوید ffmpeg نصب و در PATH است.
- **مصرف حافظه مدل**: در صورت محدودیت منابع، از مدل کوچک‌تر (مثلاً `tiny` یا `base`) استفاده کنید.
