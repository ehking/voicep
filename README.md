# مترجم ویس‌های شلوغ ایرانی (فاز ۱)

این پروژه یک MVP محلی برای آپلود فایل صوتی فارسی، حذف نویز، تبدیل گفتار به متن و پاکسازی متن است. تمامی پردازش‌ها روی سیستم محلی انجام می‌شود و هیچ وابستگی به API خارجی ندارد.

## پیش‌نیازها
- Python 3.10+
- Ubuntu 22.04 (تست شده)
- نصب ffmpeg و ffprobe
  ```bash
  sudo apt-get update && sudo apt-get install -y ffmpeg
  ```
- (اختیاری) GPU و درایور CUDA برای عملکرد بهتر مدل‌های whisper/faster-whisper

## راه‌اندازی محیط مجازی
```bash
python3 -m venv .venv
source .venv/bin/activate
```

## نصب وابستگی‌ها
```bash
pip install --upgrade pip
pip install -r requirements.txt
```

## پیکربندی
مقادیر محیطی در `.env.example` آمده است. برای سفارشی‌سازی یک فایل `.env` بسازید:
```bash
cp .env.example .env
```
متغیرهای مهم:
- `MODEL_SIZE`: اندازه مدل whisper/faster-whisper (پیش‌فرض `small`)
- `MODEL_DEVICE`: دستگاه اجرای مدل (`cpu` یا `cuda`)
- `COMPUTE_TYPE`: نوع محاسبه مدل (`int8`, `float16` و ...)
- `INITIAL_PROMPT`: پرامپت اولیه فارسی برای هدایت ASR (پیش‌فرض حاوی واژگان عاشقانه/محاوره‌ای)
- `BEAM_SIZE`: اندازه بیم جستجو (پیش‌فرض `10`)
- `VAD_FILTER`: فیلتر Voice Activity Detection (پیش‌فرض فعال)
- `RETENTION_HOURS`: مدت نگهداری فایل‌ها و رکوردها (ساعت)
- `MAX_MB`: حداکثر حجم فایل (مگابایت)
- `MAX_SECONDS`: حداکثر طول فایل (ثانیه)
- `STORAGE_DIR`: مسیر ذخیره‌سازی محلی
- `WORKER_THREADS`: تعداد نخ‌های پردازش پس‌زمینه (پیش‌فرض ۲)
- `MAX_QUEUE_SIZE`: حداکثر طول صف پردازش قبل از بازگشت خطای 429
- `USE_MLM_CORRECTION`: فعال‌سازی اصلاح زبانی مبتنی بر مدل ماسک (پیش‌فرض 0، نیازمند نصب transformers و مدل محلی)

## اجرای برنامه
```bash
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```
سپس در مرورگر به آدرس `http://localhost:8000/` بروید.

## عملکرد اصلی
- آپلود چند فایل صوتی به‌صورت هم‌زمان (حداکثر ۲۰ مگابایت و ۵ دقیقه برای هر فایل)
- صف پردازش با `queue.Queue`، پشتیبانی از چند نخ و کنترل ظرفیت
- تبدیل به WAV، حذف نویز (RNNoise در صورت وجود، در غیر این صورت `noisereduce`)
- تشخیص گفتار با `faster-whisper` (در صورت عدم وجود، `whisper` داخلی)
- پاکسازی متن فارسی شامل نرمال‌سازی حروف، جداسازی کلینیتک‌های محاوره‌ای و لایهٔ تصحیح اشتباهات متداول
- تاریخچه ۱۰ درخواست اخیر و مشاهدهٔ نتیجهٔ هر کار
- دکمه‌های کپی و دانلود متن تمیز
- پاک‌سازی زمان‌بندی‌شده فایل‌ها/رکوردهای قدیمی (هر ساعت)
- در هنگام راه‌اندازی، درخواست‌های نیمه‌تمام مجدد در صف قرار می‌گیرند.

## عیب‌یابی کیفیت متن و کلمات مخدوش
- **افزایش beam_size**: مقدار `BEAM_SIZE` را بیشتر کنید تا جستجوی مدل گسترده‌تر شود.
- **پرامپت اولیه**: مقدار `INITIAL_PROMPT` را با کلمات حوزهٔ مدنظر (مثلاً عاشقانه یا محاوره‌ای) تنظیم کنید تا مدل به واژگان درست سوگیری داشته باشد.
- **فیلتر VAD**: اگر سکوت زیاد است، `VAD_FILTER` را فعال نگه دارید؛ در محیط‌های بسیار شلوغ می‌توانید آن را غیرفعال کنید و خودتان برش بزنید.
- **تصحیح زبانی اختیاری**: با تنظیم `USE_MLM_CORRECTION=1` و نصب مدل ماسک‌شدهٔ فارسی (مثلاً ParsBERT) می‌توانید کلمات مخدوش را با پیشنهادهای مدل جایگزین کنید. در صورت نبود مدل، برنامه با هشدار ادامه می‌دهد.

## مشکلات رایج
- **نبود `faster-whisper` یا عدم دسترسی GPU**: برنامه به‌صورت خودکار به پکیج `whisper` بازمی‌گردد. سرعت پایین‌تر است اما عملکرد حفظ می‌شود.
- **نبود RNNoise**: حذف نویز با کتابخانه `noisereduce` انجام می‌شود.
- **خطای ffmpeg/ffprobe**: مطمئن شوید ffmpeg نصب و در PATH است.
- **مصرف حافظه مدل**: در صورت محدودیت منابع، از مدل کوچک‌تر (مثلاً `tiny` یا `base`) استفاده کنید.
- **خطای صف پر (429)**: مقدار `MAX_QUEUE_SIZE` را افزایش دهید یا با `WORKER_THREADS` بیشتر، پردازش را موازی‌تر کنید.
